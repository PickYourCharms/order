<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Bag - PickYourCharms</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=3.7">
</head>

<body>

<header class="navbar">
  <a href="index.html" class="logo-link">
    <img src="assets/home/PYC_LOGO_TEXT.png" class="logo-img" alt="PickYourCharms">
  </a>
  <button id="navCartBtn" class="cart-icon-btn" onclick="window.location.reload()">
    <div class="cart-badge-wrapper">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 5.68c.496 2.238.242 3.666-2.203 4.095-.97.17-2.025.218-3.116.218-1.09 0-2.146-.048-3.116-.218-2.445-.429-2.7-1.857-2.203-4.095l1.263-5.68c.24-1.08.385-1.92 2.053-2.008 2.025-.107 4.053-.107 6.078 0 1.668.088 1.813.928 2.053 2.008z" />
      </svg>
      <span id="cartCountBadge" class="cart-count">0</span>
    </div>
  </button>
</header>

<div class="page-header">
  <button onclick="window.location.href='index.html'">←</button>
  <h1>My Bag</h1>
  <div style="width: 24px;"></div>
</div>

<div class="main-container cart-page">
  
  <div id="cartItems" class="cart-list"></div>

  <div id="couponTrigger" class="coupon-trigger-bar" onclick="openCouponDrawer()">
    <div class="coupon-left">
        <span>% Apply Coupon</span>
    </div>
  </div>

  <div class="bill-summary summary-card">
    <div class="math-row"> <span>Subtotal</span> <span id="subtotalPrice">Rs. 0</span> </div>
    <div class="math-row discount-row" id="discountRow" style="display: none;"> <span>Discount</span> <span id="discountPrice">-Rs. 0</span> </div>
    <div class="math-row total-row"> <span>Total</span> <span id="totalPrice">Rs. 0</span> </div>
  </div>

  <div class="cart-footer-spacer"></div>
  <button id="checkoutBtn" class="checkout-pill" onclick="window.location.href='checkout.html'">Proceed to Checkout</button>
</div>

<div id="couponDrawer" class="coupon-drawer">
  <div class="drawer-header"><h3>Coupons</h3><button onclick="closeCouponDrawer()">X</button></div>
  <div id="drawerList"></div>
</div>

<script>
let cart = JSON.parse(localStorage.getItem('pyc_cart') || '[]');

const AVAILABLE_COUPONS = [
  { code: 'PYC100', discount: 100, minOrder: 500, desc: '₹100 off on orders above ₹500' },
  { code: 'COMBO20', discount: 0.20, minOrder: 1500, desc: '20% off on orders above ₹1500' }
];

let appliedCoupon = null;

function init() {
  document.getElementById('cartCountBadge').textContent = cart.length;
  renderCartItems();
  updateBill();
  
  // Basic Coupon Drawer Render
  const drawerList = document.getElementById('drawerList');
  if (drawerList) {
    drawerList.innerHTML = '';
    AVAILABLE_COUPONS.forEach(c => {
      const div = document.createElement('div');
      div.className = 'coupon-card-item';
      div.innerHTML = `<h4>${c.code}</h4><p>${c.desc}</p><button onclick="applyCoupon('${c.code}')">Apply</button>`;
      drawerList.appendChild(div);
    });
  }
}

function renderCartItems() {
  const container = document.getElementById('cartItems');
  container.innerHTML = '';
  
  if (cart.length === 0) {
    container.innerHTML = `<div class="empty-msg">Your bag is empty</div>`;
    document.querySelector('.summary-card').style.display = 'none';
    document.getElementById('couponTrigger').style.display = 'none';
    return;
  }

  cart.forEach((item, index) => {
    const card = document.createElement('div');
    card.className = 'cart-item-card';
    
    if (item.type && item.type.includes('Combo')) {
      // COMBO ITEM UI
      card.innerHTML = `
        <div class="item-row-content">
            <img src="${item.bracelet.image}" class="item-thumb" style="width:70px; height:70px; object-fit:contain;">
            <div class="item-details">
            <div class="item-title">Charm Combo</div>
            <div class="item-price">Rs. ${item.price}</div>
            </div>
        </div>
        <div class="item-actions" style="margin-top:10px; display:flex; gap:10px;">
            <button onclick="editItem(${index}, 'bracelet')">Edit Bracelet</button>
            <button onclick="editItem(${index}, 'earrings')">Edit Earrings</button>
            <button onclick="removeItem(${index})">Remove</button>
        </div>`;
    } else {
      // SINGLE ITEM UI
      card.innerHTML = `
        <div class="item-row-content">
            <img src="${item.image}" class="item-thumb" style="width:70px; height:70px; object-fit:contain;">
            <div class="item-details">
            <div class="item-title">${item.type}</div>
            <div class="item-price">Rs. ${item.price}</div>
            </div>
        </div>
        <div class="item-actions" style="margin-top:10px; display:flex; gap:10px;">
            <button onclick="editItem(${index})">Edit</button>
            <button onclick="removeItem(${index})">Remove</button>
        </div>`;
    }
    container.appendChild(card);
  });
}

function editItem(index, subType) {
  const item = cart[index];
  let draft = {};
  let url = '';

  sessionStorage.removeItem('pyc_draft');
  sessionStorage.removeItem('combo_bracelet_data');
  sessionStorage.removeItem('combo_earring_data');

  if (item.type.includes('Combo')) {
    if (subType === 'bracelet') {
      // FIX #2: Stash the EXISTING earring data so it isn't lost
      sessionStorage.setItem('combo_earring_data', JSON.stringify(item.earrings));
      
      draft = { url: 'builder.html?mode=combo', data: { metal: item.bracelet.metal, charms: item.bracelet.charms } };
      url = 'builder.html?mode=combo&resume=true';
    } else {
      sessionStorage.setItem('combo_bracelet_data', JSON.stringify(item.bracelet));
      draft = { 
        url: 'earring-builder.html?mode=combo', 
        data: { metal: item.earrings.metal, charms: item.earrings.charms },
        comboContext: { bracelet: item.bracelet }
      };
      url = 'earring-builder.html?mode=combo&resume=true';
    }
  } 
  else if (item.type === 'Bracelet') {
    draft = { url: 'builder.html', data: { metal: item.metal, charms: item.charms } };
    url = 'builder.html?resume=true';
  } 
  else { 
    draft = { url: 'earring-builder.html', data: { metal: item.metal, charms: item.charms } };
    url = 'earring-builder.html?resume=true';
  }

  sessionStorage.setItem('pyc_draft', JSON.stringify(draft));
  cart.splice(index, 1);
  localStorage.setItem('pyc_cart', JSON.stringify(cart));
  window.location.href = url;
}

function removeItem(index) {
    cart.splice(index, 1);
    localStorage.setItem('pyc_cart', JSON.stringify(cart));
    init();
}

function updateBill() {
  let subtotal = 0;
  cart.forEach(item => subtotal += Number(item.price) || 0);
  document.getElementById('subtotalPrice').textContent = "Rs. " + subtotal;
  document.getElementById('totalPrice').textContent = "Rs. " + subtotal;
}

function openCouponDrawer() { document.getElementById('couponDrawer').classList.add('open'); }
function closeCouponDrawer() { document.getElementById('couponDrawer').classList.remove('open'); }
function applyCoupon(code) { closeCouponDrawer(); alert('Coupon ' + code + ' applied!'); }

window.onload = init;
</script>
</body>
</html>
