<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Bag - PickYourCharms</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=3.7">
  <link rel="stylesheet" href="desktop.css">
  <script src="store_data.js"></script>
  <script src="desktop.js"></script>
  <script src="navigation.js"></script>
  
  <style>
    /* ✅ ADDED: Styles for the Coupon Button Interaction */
    .coupon-input-wrapper button {
      background: #fff;
      border: none;
      border-left: 1px solid #ddd;
      color: #ccc; /* Default 'disabled' look */
      padding: 0 16px;
      font-weight: 600;
      cursor: default;
      transition: all 0.2s ease;
    }
    
    .coupon-input-wrapper button.ready {
      color: #15803d; /* Brand Green */
      cursor: pointer;
      background-color: #f0fdf4; /* Slight green tint */
      font-weight: 700;
    }
  </style>
</head>

<body>

<header class="navbar">
  <div class="nav-left">
    <button class="nav-btn" onclick="window.location.href='index.html'">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
      </svg>
    </button>
  </div>

  <div class="nav-center">
    <span style="font-weight: 700; font-size: 16px;">My Bag</span>
  </div>

  <div class="nav-right">
    <button id="navCartBtn" class="nav-btn" onclick="window.location.reload()">
      <div class="cart-badge-wrapper">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 5.68c.496 2.238.242 3.666-2.203 4.095-.97.17-2.025.218-3.116.218-1.09 0-2.146-.048-3.116-.218-2.445-.429-2.7-1.857-2.203-4.095l1.263-5.68c.24-1.08.385-1.92 2.053-2.008 2.025-.107 4.053-.107 6.078 0 1.668.088 1.813.928 2.053 2.008z" />
        </svg>
        <span id="cartCountBadge" class="cart-count">0</span>
      </div>
    </button>
  </div>
</header>

<div class="main-container cart-page">
  
<div id="emptyState" class="empty-state">
  <img src="assets/home/curated_teaser.png" class="empty-img" style="filter:grayscale(1);">
    <h3>Nothing to see here yet!</h3>
    <p>Your bag is feeling lonely...</p>
    <button class="primary-btn" onclick="window.location.href='index.html'">Start Building</button>
  </div>

  <div id="cartContent" style="display: none;">
    
    <div id="cartItemsList" class="cart-list"></div>

    <div class="bill-summary">
      <div id="couponSectionRaw" class="coupon-section-container">
        <div class="featured-coupon-card" id="featuredCouponCard"></div>
        <div class="view-more-coupons" onclick="openCouponDrawer()">
          View more coupons
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </div>
      </div>

      <div id="appliedCouponView" class="coupon-applied-view" style="display: none;">
        <div style="display:flex; align-items:center; gap:8px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#15803d" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          <span id="appliedCouponText" style="font-weight:700;"></span>
        </div>
        <button class="remove-coupon-btn" onclick="removeCoupon()">✕</button>
      </div>

      <div id="couponOverlay" class="coupon-drawer-overlay" onclick="closeCouponDrawer()"></div>
      <div id="couponDrawer" class="coupon-drawer">
        <div class="drawer-header"> 
          <h3>Apply Coupon</h3>
          <button class="close-drawer-btn" onclick="closeCouponDrawer()">✕</button>
        </div>
        
        <div class="coupon-input-container">
          <div class="coupon-input-wrapper">
            <input type="text" id="manualInput" placeholder="Enter Coupon Code">
            <button onclick="checkManualCode()">APPLY</button>
          </div>
        </div>
        <div id="drawerList" class="drawer-content"></div>
      </div>

      <div class="math-row"> <span>Cart Value</span> <span id="cartValueVal">Rs. 0</span> </div>
      
      <div class="math-row discount-row" id="comboRow" style="display: none;"> <span>Combo Savings</span> <span id="comboVal">-Rs. 0</span> </div>
      <div class="math-row discount-row" id="couponRow" style="display: none;"> <span id="couponCodeLabel">Coupon</span> <span id="couponVal">-Rs. 0</span> </div>
      
      <div class="divider"></div>
      
      <div class="math-row"> <span style="font-weight:600;">Subtotal</span> <span id="subtotalVal" style="font-weight:600;">Rs. 0</span> </div>
      <div class="math-row"> <span>Shipping</span> <span id="shippingVal">Rs. 80</span> </div>
      
      <div class="divider"></div>
      <div class="math-row total-row"> <span>Total</span> <span id="finalTotal">Rs. 0</span> </div>      
    </div>
    
    <div class="cart-footer-spacer"></div>
    <button id="checkoutBtn" class="checkout-pill" onclick="onCheckoutClick()">Proceed to Checkout</button>
  </div>
</div>

<div id="checkoutUpsellModal" class="upsell-modal-overlay">
  <div class="upsell-modal-card">
    <button class="primary-btn" style="width: 100%; margin-bottom: 12px;" onclick="window.location.href='index.html'">
      Uggghhh! I want some more!
    </button>
    <a href="javascript:void(0)" class="secondary-link" onclick="forceCheckout()">Maybe Later</a>
  </div>
</div> 

<div id="deleteModal" class="delete-modal-overlay">
  <div class="delete-modal-card">
    <h3>Remove Item?</h3>
    <p>Are you sure you want to remove this from your bag? This action cannot be undone.</p>
    <div class="delete-actions">
      <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
      <button class="confirm-btn" onclick="confirmDelete()">Yes, Remove</button>
    </div>
  </div>
</div>

<div id="messageModal" class="delete-modal-overlay">
  <div class="delete-modal-card">
    <h3 id="msgTitle" style="margin-bottom:8px;">Oops!</h3>
    <p id="msgBody" style="margin-bottom:20px; color:#666;">You've entered an invalid coupon.</p>
    <div class="delete-actions">
      <button class="confirm-btn" style="background:#000; width:100%;" onclick="closeMessageModal()">Okay</button>
    </div>
  </div>
</div>  
  
<script>
// ===================================
// ✅ FULLY FIXED: PERSISTENT COUPONS & SHEET DRIVEN
// ===================================

// --- LOAD CONFIGURATION FROM GOOGLE SHEET ---
const CONFIG = JSON.parse(localStorage.getItem('pyc_config') || "{}");
const CHARM_METADATA = JSON.parse(localStorage.getItem('pyc_charm_metadata') || "{}");
const COUPONS_DB = JSON.parse(localStorage.getItem('pyc_coupons') || "[]");

// ✅ NO FALLBACK VALUES - EVERYTHING FROM SHEET
const BASE_PRICE = Number(CONFIG.bracelet_base_price) || 0;
const EARRING_BASE_PRICE = Number(CONFIG.earring_base_price) || 0;

const REF_SIZE = 300; 
const PHYSICS = { 
  bracelet: { anchorX:23, anchorY:6, attachOffset:2 },
  earrings: { leftX: 42, rightX: 257, y: 153 } 
};
const B_ANGLES = { 1:[90], 2:[70,110], 3:[60,90,120], 4:[45,75,105,135], 5:[40,65,90,115,140] };

let cart = JSON.parse(localStorage.getItem('pyc_cart') || '[]');
let activeCoupon = null;

const listContainer = document.getElementById('cartItemsList');
const cartCountBadge = document.getElementById('cartCountBadge');
const emptyState = document.getElementById('emptyState');
const cartContent = document.getElementById('cartContent');

function init() {
  cartCountBadge.textContent = cart.length;
  document.getElementById('navCartBtn').style.display = cart.length > 0 ? 'block' : 'none';

  if (cart.length === 0) {
    emptyState.style.display = 'flex';
    cartContent.style.display = 'none';
    activeCoupon = null;
    sessionStorage.removeItem('pyc_applied_coupon');
  } else {
    emptyState.style.display = 'none';
    cartContent.style.display = 'block';
    
    // ✅ 1. RESTORE COUPON FROM SESSION STORAGE
    const savedCoupon = sessionStorage.getItem('pyc_applied_coupon');
    if (savedCoupon) {
      try {
        activeCoupon = JSON.parse(savedCoupon);
        // Restore UI State
        document.getElementById('couponSectionRaw').style.display = 'none';
        document.getElementById('appliedCouponView').style.display = 'flex';
        document.getElementById('appliedCouponText').textContent = `'${activeCoupon.code}' applied`;
      } catch (e) {
        console.error("Error restoring coupon", e);
        sessionStorage.removeItem('pyc_applied_coupon');
      }
    }

    renderItems();
    renderCoupons();
    calculateTotals();
  }

  setTimeout(() => {
    window.history.pushState(null, null, window.location.href);
  }, 100);
  
  window.onpopstate = function () {
    window.location.href = 'index.html';
  };
}

window.addEventListener('pageshow', function(event) {
  if (event.persisted) {
    document.getElementById('checkoutUpsellModal').style.display = 'none';
    init();
  }
});

// --- MINI BUILDERS ---
function buildMiniBracelet(metal, charms) {
  const container = document.createElement('div');
  container.className = 'mini-canvas-scaler';
  
  const base = document.createElement('img');
  base.className = 'mini-base';
  base.src = `assets/bases/bracelet_base_${metal}.png`;
  base.style.top = '40%'; 
  container.appendChild(base);

  const cx = REF_SIZE / 2;
  const cy = (REF_SIZE / 2) - 30; 
  const radius = REF_SIZE * 0.36;
  const angles = B_ANGLES[charms.length] || [];

  charms.forEach((file, i) => {
    const a = angles[angles.length - 1 - i];
    const rad = a * Math.PI / 180;
    const x = cx + radius * Math.cos(rad);
    const y = cy + radius * Math.sin(rad) + PHYSICS.bracelet.attachOffset;
    
    const img = document.createElement('img');
    img.className = 'mini-charm';
    img.src = `assets/charms/${file}`;
    img.style.left = (x - PHYSICS.bracelet.anchorX) + 'px';
    img.style.top = (y - PHYSICS.bracelet.anchorY) + 'px';
    img.style.transform = `rotate(${a - 90}deg)`;
    container.appendChild(img);
  });
  return container;
}

function buildMiniEarrings(metal, charms) {
  const container = document.createElement('div');
  container.className = 'mini-canvas-scaler';

  const lHook = document.createElement('img');
  lHook.src = `assets/bases/LeftHook_${metal}.png`;
  lHook.className = 'mini-hook left';
  container.appendChild(lHook);

  const rHook = document.createElement('img');
  rHook.src = `assets/bases/RightHook_${metal}.png`;
  rHook.className = 'mini-hook right';
  container.appendChild(rHook);

  if (charms.left) {
    const c = document.createElement('img');
    c.className = 'mini-charm';
    c.src = `assets/charms/${charms.left}`;
    c.style.left = (PHYSICS.earrings.leftX - 23) + 'px';
    c.style.top = PHYSICS.earrings.y + 'px';
    container.appendChild(c);
  }
  if (charms.right) {
    const c = document.createElement('img');
    c.className = 'mini-charm';
    c.src
